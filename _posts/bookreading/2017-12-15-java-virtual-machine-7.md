---
layout: post
title: 阅读《深入理解JAVA虚拟机》6
categories: BookReading
description: 阅读笔记
keywords: 读书
---
深入理解java虚拟机 读书笔记 6

# 第六章 类文件结构
## 概述
java的程序文件最终是被转化成了与操作系统和机器指令集无关的、平台中立的格式作为程序编译后的存储格式。

## 无关性的基石
各种不同的平台的虚拟机与所有平台都统一使用的程序存储格式-字节码(ByteCode)是构成无关性的基石，虚拟机同时有着另一个中立特性-语言无关性。除了java语言以外，Clojure,Groovy,Scala,Jython等语言都可以运行在java虚拟机上。
Java虚拟机不和包括Java在内的任何语言绑定，它只与“Class文件”这种特定的二进制文件格式所关联，Class文件中包含了Java虚拟机指令集和符号表以及若干其他辅助信息。任何其他语言都可以将虚拟机作为语言的产品交付媒介。
## Class类文件的结构
Class文件是一组以8位字节为基础单元的二进制流，各个数据项目严格按照顺序紧走地排列在Class文件中，中间没有添加任何分隔符，这使得整个Class文件中存储的内容几乎全部是程序运行的必要数据。当遇到需要占用8位字节以上空间的数据项时，则会按照高位在前的方式分割成若干个8位字节进行存储。</br>
Class文件格式采用一种类似于C语言结构的伪结构来存储数据。其中只包含两种数据：无符号和表，后面的解析都要以这两种数据类型为基础。</br>
无符号表属于基本的数据结构，以u1\u2\u4\u8来分别代表1个字节、2个字节、4个字节和8个字节的无符号数。
可以用来描述数字、索引引用、数量值等。</br>
表是由多个无符号数或者其他表作为数据项构成的复合数据类型，一般以“_info”结尾。整个Class文件本质上就是一个表。
Class的投4个字节被称为魔数，用于确定是否是一个合法的Class文件。然后是4字节的版本号，即5、6字节是次版本号，7、8字节是主版本号。</br>
从第9字节开始是常量池的入口，先放置一个u2类型的数据，代表常量池容量计数值(constant_pool_count)。索引值从1开始计数，所以0x16代表十进制的22即有21个常量。Class中只有这个值索引从1开始。常量池中存放两大类常量：字面量(Literal)和符号引用(Symbolic Rerference)。</br>
Java代码在编译的时候，并不像C那样有“连接”的步骤，而是在虚拟机加载Class文件进行动态连接。也就是Class文件中不会保存各个方法、字段的最终内存布局信息，因此这些字段、方法不经过运行期转化的话无法得到真正的内存入口地址。当虚拟机运行的时候，需要从常量池获得对应的符号引用，再在类创建或运行时解析、翻译到具体的内存地址中。
常量池中每一个常量都是一个表，从1.7版本开始，有14种表结构。</br>
表的一开始是一个u1数字，是一个标识位，代表常量类型。

![图片1](/images/bookreading/jvm6/1.png)
然后跟着一个u2数字，name_index，是一个索引值，指向常量池中的一个CONSTANT_Utf8_info类型常量，代表了这个类的全限定名，
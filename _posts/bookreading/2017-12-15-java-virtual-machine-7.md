---
layout: post
title: 阅读《深入理解JAVA虚拟机》7
categories: BookReading
description: 阅读笔记
keywords: 读书
---
深入理解java虚拟机 读书笔记 7

# 第七章 虚拟机类加载机制
## 概述
虚拟机把描述类的数据从Class文件加载到内存，并对数据进行校验、转换解析和初始化，最终形成可以被虚拟机直接使用的Java类型。在Java语言里，类型的加载、连接和初始化过程都是在程序运行期间完成的，Java里天生可以动态拓展的语言特性就是依赖运行期动态加载和动态连接这个特点实现的。例如，如果编写一个面向接口的应用程序，可以等到运行时
再指定其实际的实现类。从最基础的Applet、jsp到相对复杂的OSGi技术，都是使用了Java语言运行期间类加载的特性。
## 类加载的时机
类的整个生命周期包括：加载(Loading)、验证(Verification)、准备(Preparation)、解析(Resolution)、初始化(Initialization)、使用(Using)和卸载(Unloading)7个阶段。验证、准备、解析3个部分统称为连接(Linking)。
![图片1](/images/bookreading/jvm7/1.png)
除了解析和初始化的前后顺序不一定以外，别的过程的先后顺序是确定的。对于初始化阶段，虚拟机规范严格规定了有且只有五种情况必须立即对类进行“初始化”。
1. 遇到new,getstatic,putstatic或者invokestatic这四条字节码指令时。如果类没有进行过初始化，则需要先触发其初始化。对应的场景分别是：使用new关键词实例化对象的时候、读取或设置一个类的静态字段的时候、调用一个类的静态方法的时候。
2. 使用java.lang.reflect包的方法对类进行反射调用的时候，如果类没有进行过初始化，则要触发其初始化。
3. 当初始化一个类的时候，如果发现其父类还没有进行过初始化，则要先触发父类的初始化。
4. 当虚拟机启动时，用户需要指定一个要执行的主类（即包含main()方法的那个类），则这个类会被先初始化。
5. 当时用JDK 1.7的动态语言支持时，如果一个java.lang.invoke.MethodHandle实例最后的解析结果是某几个方法句柄，并且对应的类没有初始化，则需要先触发其初始化。
注意点 （1）对于静态字段，只有直接定义这个字段的类才会被初始化，因此通过其子类来引用父类中定义的静态字段，只会触发父类的初始化。（2）通过数组定义来引用类，不会触发此类的初始化。（3）常量在编译阶段会存入调用类的常量池中，本质上并没有直接引用到定义常量的类，因此不会触发初始化。
---
layout: post
title: 阅读《深入理解JAVA虚拟机》9
categories: BookReading
description: 阅读笔记
keywords: 读书
---
深入理解java虚拟机 读书笔记 9

# 第九章 类加载及执行子系统的案例与实战
## Tomcat 正统的类加载架构
主流的Java Web服务器，都实现了自己定义的类加载器
## 类加载的时机
类的整个生命周期包括：加载(Loading)、验证(Verification)、准备(Preparation)、解析(Resolution)、初始化(Initialization)、使用(Using)和卸载(Unloading)7个阶段。验证、准备、解析3个部分统称为连接(Linking)。
![图片1](/images/bookreading/jvm7/1.png)
除了解析和初始化的前后顺序不一定以外，别的过程的先后顺序是确定的。对于初始化阶段，虚拟机规范严格规定了有且只有五种情况必须立即对类进行“初始化”。
1. 遇到new,getstatic,putstatic或者invokestatic这四条字节码指令时。如果类没有进行过初始化，则需要先触发其初始化。对应的场景分别是：使用new关键词实例化对象的时候、读取或设置一个类的静态字段的时候、调用一个类的静态方法的时候。
2. 使用java.lang.reflect包的方法对类进行反射调用的时候，如果类没有进行过初始化，则要触发其初始化。
3. 当初始化一个类的时候，如果发现其父类还没有进行过初始化，则要先触发父类的初始化。
4. 当虚拟机启动时，用户需要指定一个要执行的主类（即包含main()方法的那个类），则这个类会被先初始化。
5. 当时用JDK 1.7的动态语言支持时，如果一个java.lang.invoke.MethodHandle实例最后的解析结果是某几个方法句柄，并且对应的类没有初始化，则需要先触发其初始化。

注意点 （1）对于静态字段，只有直接定义这个字段的类才会被初始化，因此通过其子类来引用父类中定义的静态字段，只会触发父类的初始化。（2）通过数组定义来引用类，不会触发此类的初始化。（3）常量在编译阶段会存入调用类的常量池中，本质上并没有直接引用到定义常量的类，因此不会触发初始化。

## 类加载的过程
### 加载
在加载阶段，虚拟机需要完成三件事。（1）通过一个类的全限定名来获取此类的二进制字节流。（2）将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。（3）在内存中生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据的访问入口。
由于这个限制并不明确，所以如何获取这个二进制字节流的方法有很多方法。例如
* 从ZIP包中获取，成为日后JAR,EAR,WAR格式的基础。
* 从网络中获取，这种场景最典型的应用就是Applet。
* 运行时计算生成，多见于动态代理技术，在java.lang.reflect.Proxy中，就是用了ProxyGenerator.generateProxyClass来为特定的接口生成二进制字节流。
* 从其他文件生成，典型场景是JSP应用，即由JSP文件生成对应的Class类。
* 从数据库读取。
一个非数组类的加载阶段可以使用系统提供的引导类加载器来完成，也可以由用户自定义的类加载类去完成。开发人员可以通过定义自己的类加载器去控制字节流的获取方式。（即重写一个类加载器的loadClass()方法）。
对于数组类而言不同，数组类本身不通过类加载器创建，它是由Java虚拟机直接创建的。而数组的元素最终是要靠加载器去创建。
加载阶段完成后，虚拟机外部的二进制字节流就按照虚拟机所需的格式存储在方法区之中，方法区中的数据存储格式由虚拟机自己实现。然后在内存中实例化一个java.lang.Class类的对象，这个对象将作为程序访问方法区中的这些类型数据的外部接口。
加载阶段与连接阶段的部分内容是交叉进行的。
### 验证
验证是连接阶段的第一步，这一阶段的目的是为了确保Class文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全。
1. 文件格式验证
第一阶段要验证字节流是否符合Class文件格式的规范，并且能被当前版本的虚拟机处理。包括检查是否以魔数开头，主、次版本号是否在当前虚拟机处理范围内，常量池的常量中是否有不被支持的常量类型、指向常量的各种索引值中是否有指向不存在的常量或不符合类型的常量或不符合类型的常量、CONSTANT_Utf8_info型的常量是否有不符合UTF8编码的数据。
2. 元数据验证
第二阶段是对字节码描述的信息进行语义分析，以保证其描述的信息符合Java语言规范。
是否有父类、父类是否继承了不允许被继承的类、如果不是抽象类则需要实现其父类或接口中要求实现的所有方法、类的字段，方法是否和父类产生矛盾。
3. 字节码验证
第三阶段是整个验证过程中最复杂的一个阶段，主要目的是通过数据流和控制流分析，确定程序语义是合法的、符合逻辑的。
